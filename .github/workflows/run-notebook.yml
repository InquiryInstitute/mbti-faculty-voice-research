name: Execute MBTI Research Notebook

on:
  workflow_dispatch:  # Manual trigger
  schedule:
    # Run daily at 2 AM UTC (optional)
    - cron: '0 2 * * *'
  push:
    branches:
      - main
    paths:
      - 'MBTI_Research_Colab.ipynb'
      - 'mbti_voice_eval.py'
      - '.github/workflows/run-notebook.yml'

jobs:
  execute-notebook:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install jupyter nbconvert ipykernel
          pip install -r requirements.txt
          pip install pandas matplotlib seaborn
      
      - name: Setup API keys (from secrets)
        env:
          OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
        run: |
          echo "OPENROUTER_API_KEY=${OPENROUTER_API_KEY}" >> $GITHUB_ENV
          echo "NEXT_PUBLIC_SUPABASE_URL=${SUPABASE_URL}" >> $GITHUB_ENV
          echo "NEXT_PUBLIC_SUPABASE_ANON_KEY=${SUPABASE_ANON_KEY}" >> $GITHUB_ENV
          echo "✅ API keys configured (from secrets)"
      
      - name: Convert notebook to Python script
        run: |
          jupyter nbconvert --to script MBTI_Research_Colab.ipynb --stdout > notebook_script.py || echo "⚠️ Conversion failed, will try direct execution"
      
      - name: Execute notebook (if results exist)
        continue-on-error: true
        run: |
          # Try to execute analysis cells if results exist
          python3 -c "
          import pandas as pd
          import json
          import os
          
          # Try to load results
          try:
              df = pd.read_csv('mbti_voice_results.csv')
              df_valid = df[df['voice_accuracy'] != -1]
              print(f'✅ Found {len(df_valid)} valid results')
              
              # Generate summary
              if len(df_valid) > 0:
                  print(f'Average voice accuracy: {df_valid[\"voice_accuracy\"].mean():.2f}')
                  print(f'Total trials: {len(df_valid)}')
          except FileNotFoundError:
              print('⚠️  No results file found - skipping analysis')
          except Exception as e:
              print(f'⚠️  Error: {e}')
          "
      
      - name: Upload results (if generated)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: notebook-results
          path: |
            *.png
            *.csv
            *.json
            *.md
          if-no-files-found: ignore
      
      - name: Comment on PR (if PR)
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: '✅ Notebook execution completed. Check artifacts for results.'
            })
